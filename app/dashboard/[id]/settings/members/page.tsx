'use client'
import {useEffect,useMemo,useState} from 'react'
import {ChevronDown,Search,MoreHorizontal} from 'lucide-react'
import {ShowcaseSection} from '@/components/Layouts/showcase-section'
import './_components/members.scss'
type Role='admin'|'member'|'guest'
type User={id:string;display_name:string;avatar_url:string|null;email:string|null;role:Role;created_at:string|null;last_sign_in_at:string|null;email_confirmed_at:string|null;auth_providers:string[]}
export default function MembersPage(){const[users,setUsers]=useState<User[]>([]);const[selectedUsers,setSelectedUsers]=useState<string[]>([]);const[searchQuery,setSearchQuery]=useState('');const[isLoading,setIsLoading]=useState(true);const[isPruning,setIsPruning]=useState(false);const[error,setError]=useState<string|null>(null);useEffect(()=>{const fetchUsers=async()=>{try{setIsLoading(true);const res=await fetch('/api/get-all-users',{cache:'no-store'});if(!res.ok)throw new Error('Failed to fetch users');const data=(await res.json()) as User[];setUsers(data)}catch(err){console.error('Error fetching users:',err);setError(err instanceof Error?err.message:'An unknown error occurred')}finally{setIsLoading(false)}};fetchUsers()},[]);const toggleUserSelection=(id:string)=>{setSelectedUsers(prev=>prev.includes(id)?prev.filter(userId=>userId!==id):[...prev,id])};const filteredUsers=useMemo(()=>{const q=searchQuery.trim().toLowerCase();if(!q)return users;return users.filter(u=>(u.display_name||'').toLowerCase().includes(q)||((u.email||'').toLowerCase().includes(q)))},[users,searchQuery]);const toggleSelectAll=()=>{if(selectedUsers.length===filteredUsers.length){setSelectedUsers([])}else{setSelectedUsers(filteredUsers.map(u=>u.id))}};const formatDate=(dateString:string|null)=>{if(!dateString)return'—';try{return new Date(dateString).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'})}catch{return dateString}};const formatProviders=(providers:string[]|null|undefined)=>{if(!providers||providers.length===0)return'—';return providers.join(', ')};const roleBadge=(role:Role)=>role||'member';const pruneSelected=async()=>{if(isPruning||selectedUsers.length===0)return;const ok=confirm(`Delete ${selectedUsers.length} selected user(s)?`);if(!ok)return;try{setIsPruning(true);const results=await Promise.all(selectedUsers.map(async(uuid)=>{const res=await fetch('/api/profile/admin-delete-user',{method:'DELETE',headers:{'content-type':'application/json'},body:JSON.stringify({uuid})});const json=await res.json().catch(()=>null) as {error?:string}|null;return{ok:res.ok,uuid,error:res.ok?null:(json?.error||'Delete failed')}}));const failed=results.filter(r=>!r.ok);if(failed.length){alert('Some deletions failed:\n'+failed.map(f=>`${f.uuid}: ${f.error}`).join('\n'))}const deleted=new Set(results.filter(r=>r.ok).map(r=>r.uuid));setUsers(prev=>prev.filter(u=>!deleted.has(u.id)));setSelectedUsers(prev=>prev.filter(id=>!deleted.has(id)))}catch(err){console.error(err);alert(err instanceof Error?err.message:'Prune failed')}finally{setIsPruning(false)}};if(isLoading){return(<ShowcaseSection title="Members Management"><div className="text-center py-10"><div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-[hsl(var(--sidebar-primary))] border-t-transparent"></div><p className="mt-2 text-[hsl(var(--foreground))]">Loading users...</p></div></ShowcaseSection>)}if(error){return(<ShowcaseSection title="Members Management"><div className="text-center py-10 text-[hsl(var(--destructive))]">{error}</div></ShowcaseSection>)}return(<ShowcaseSection title="Members Management"><div className="flex justify-between items-center mb-6"><div className="relative w-full max-w-md"><input type="text" placeholder="Search by username or email" value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2 border rounded-[var(--radius)] bg-[hsl(var(--muted))] text-[hsl(var(--foreground))] border-[hsl(var(--border))]"/><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-[hsl(var(--muted-foreground))]" size={20}/></div><div className="flex space-x-4"><button className="flex items-center gap-2 rounded-[var(--radius)] px-4 py-2 bg-[hsl(var(--muted))] text-[hsl(var(--foreground))] border border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] transition-colors" type="button">Sort <ChevronDown size={16}/></button><button className="rounded-[var(--radius)] px-4 py-2 bg-[hsl(var(--destructive))] text-[hsl(var(--destructive-foreground))] hover:bg-[hsl(var(--destructive))/0.9] transition-colors shadow-[var(--shadow-xs)] disabled:opacity-60 disabled:cursor-not-allowed" type="button" onClick={pruneSelected} disabled={isPruning||selectedUsers.length===0}>{isPruning?'Pruning...':'Prune'}</button></div></div><div className="overflow-x-auto members-table"><table className="w-full text-sm"><thead className="bg-[hsl(var(--muted))] border-b border-[hsl(var(--border))]"><tr><th className="p-3 text-left"><input type="checkbox" checked={filteredUsers.length>0&&selectedUsers.length===filteredUsers.length} onChange={toggleSelectAll} className="form-checkbox rounded-[calc(var(--radius)_-_2px)] text-[hsl(var(--sidebar-primary))] border-[hsl(var(--border))]"/></th><th className="p-3 text-left text-[hsl(var(--muted-foreground))] uppercase font-[var(--font-sans)]">NAME</th><th className="p-3 text-left text-[hsl(var(--muted-foreground))] uppercase font-[var(--font-sans)]">EMAIL</th><th className="p-3 text-left text-[hsl(var(--muted-foreground))] uppercase font-[var(--font-sans)]">ROLE</th><th className="p-3 text-left text-[hsl(var(--muted-foreground))] uppercase font-[var(--font-sans)]">CREATED</th><th className="p-3 text-left text-[hsl(var(--muted-foreground))] uppercase font-[var(--font-sans)]">LAST LOGIN</th><th className="p-3 text-left text-[hsl(var(--muted-foreground))] uppercase font-[var(--font-sans)]">AUTH PROVIDERS</th><th className="p-3 text-right text-[hsl(var(--muted-foreground))] uppercase font-[var(--font-sans)]">ACTIONS</th></tr></thead><tbody>{filteredUsers.map(user=>(<tr key={user.id} className="border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] transition-colors"><td className="p-3"><input type="checkbox" checked={selectedUsers.includes(user.id)} onChange={()=>toggleUserSelection(user.id)} className="form-checkbox rounded-[calc(var(--radius)_-_2px)] text-[hsl(var(--sidebar-primary))] border-[hsl(var(--border))]"/></td><td className="p-3"><div className="flex items-center space-x-3"><img src={user.avatar_url||'/images/user/user-03.png'} alt={user.display_name} className="w-10 h-10 rounded-full object-cover shadow-[var(--shadow-xs)]"/><span className="font-medium text-[hsl(var(--foreground))]">{user.display_name||'Unnamed User'}</span></div></td><td className="p-3 text-[hsl(var(--muted-foreground))]">{user.email||'—'}</td><td className="p-3"><span className="bg-[hsl(var(--muted))] text-[hsl(var(--muted-foreground))] px-2 py-1 rounded-full text-xs">{roleBadge(user.role)}</span></td><td className="p-3 text-[hsl(var(--muted-foreground))]">{formatDate(user.created_at)}</td><td className="p-3 text-[hsl(var(--muted-foreground))]">{formatDate(user.last_sign_in_at)}</td><td className="p-3 text-[hsl(var(--muted-foreground))]">{formatProviders(user.auth_providers)}</td><td className="p-3 text-right"><button className="text-[hsl(var(--muted-foreground))] hover:bg-[hsl(var(--accent))] p-2 rounded-[var(--radius)] transition-colors" type="button"><MoreHorizontal size={20}/></button></td></tr>))}</tbody></table></div><div className="flex justify-between items-center mt-6"><span className="text-[hsl(var(--muted-foreground))]">Showing {filteredUsers.length} of {users.length} members</span><div className="flex space-x-2 pagination"><button className="px-4 py-2 bg-[hsl(var(--muted))] text-[hsl(var(--foreground))] rounded-[var(--radius)] page-btn shadow-[var(--shadow-xs)]" type="button">Back</button><button className="px-4 py-2 bg-[hsl(var(--sidebar-primary))] text-[hsl(var(--sidebar-primary-foreground))] rounded-[var(--radius)] active-page shadow-[var(--shadow-xs)]" type="button">1</button><button className="px-4 py-2 bg-[hsl(var(--muted))] text-[hsl(var(--foreground))] rounded-[var(--radius)] page-btn shadow-[var(--shadow-xs)]" type="button">Next</button></div></div></ShowcaseSection>)}
